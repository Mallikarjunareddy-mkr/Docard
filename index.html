<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IndexedDB File Manager</title>
<style>
body { margin:0; font-family: Arial; background:#f5f5f5; }
header { background:#333; color:white; padding:1rem; text-align:center; }
button { padding:8px 15px; margin:5px; cursor:pointer; }
.container { padding:15px; }
#homePage, #fileManager { display:none; }
#sidebar { float:left; width:200px; background:#ddd; padding:10px; min-height:400px; }
#fileView { margin-left:220px; padding:10px; background:#fff; min-height:400px; overflow-y:auto; }
.fileItem { border:1px solid #ccc; padding:5px; margin:5px 0; display:flex; justify-content:space-between; align-items:center; }
.dark-mode { background:#222; color:#eee; }
.dark-mode #sidebar { background:#444; }
.dark-mode #fileView { background:#333; color:#eee; }
</style>
</head>
<body>

<header>
<h1>IndexedDB File Manager</h1>
<button onclick="toggleDarkMode()">Toggle Dark Mode</button>
</header>

<!-- Home Page -->
<div class="container" id="homePage" style="display:block;">
  <button onclick="openLocal()">Local Storage</button>
</div>

<!-- Local Storage Manager -->
<div class="container" id="fileManager">
  <button onclick="goHome()">Back</button>
  <h2>Local Storage Manager (IndexedDB)</h2>
  <div id="sidebar">
    <button onclick="createFolder()">New Folder</button>
    <button onclick="createFile()">New File</button>
    <input type="text" id="searchBox" placeholder="Search..." oninput="searchFiles()">
  </div>
  <div id="fileView"></div>
</div>

<script>
// =================== Navigation ===================
function openLocal() {
  document.getElementById('homePage').style.display='none';
  document.getElementById('fileManager').style.display='block';
  initDB();
}
function goHome() {
  document.getElementById('fileManager').style.display='none';
  document.getElementById('homePage').style.display='block';
}

// =================== Dark Mode ===================
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

// =================== IndexedDB Setup ===================
let db;
function initDB(){
  const request = indexedDB.open("FileManagerDB", 1);

  request.onerror = (event) => { console.error("DB error:", event); };
  request.onsuccess = (event) => {
    db = event.target.result;
    loadFiles();
  };

  request.onupgradeneeded = (event) => {
    db = event.target.result;
    const store = db.createObjectStore("files", { keyPath: "id", autoIncrement:true });
    store.createIndex("name", "name", { unique: false });
    store.createIndex("type", "type", { unique: false });
    store.createIndex("parent", "parent", { unique: false });
  };
}

// =================== File Operations ===================
function addFileToDB(file){
  const tx = db.transaction("files", "readwrite");
  const store = tx.objectStore("files");
  store.add(file);
  tx.oncomplete = loadFiles;
}

function getAllFiles(callback){
  const tx = db.transaction("files", "readonly");
  const store = tx.objectStore("files");
  const request = store.getAll();
  request.onsuccess = () => callback(request.result);
}

// =================== UI & Actions ===================
function loadFiles(filter=''){
  getAllFiles(files=>{
    const view = document.getElementById('fileView');
    view.innerHTML = '';
    files.forEach(f=>{
      if(filter && !f.name.toLowerCase().includes(filter.toLowerCase())) return;
      const div = document.createElement('div');
      div.className='fileItem';
      div.innerHTML=`<span>${f.name} (${f.type})</span>
        <span>
          <button onclick="renameFile(${f.id})">Rename</button>
          <button onclick="deleteFile(${f.id})">Delete</button>
          ${f.type==='file'?`<button onclick="previewFile(${f.id})">Preview</button>`:''}
        </span>`;
      view.appendChild(div);
    });
  });
}

function createFolder(){
  const name = prompt("Folder name:");
  if(name) addFileToDB({name, type:'folder', parent:null, children:[]});
}

function createFile(){
  const name = prompt("File name:");
  if(name){
    const content = prompt("File content:");
    addFileToDB({name, type:'file', content, parent:null});
  }
}

function renameFile(id){
  const newName = prompt("New name:");
  if(!newName) return;
  const tx = db.transaction("files", "readwrite");
  const store = tx.objectStore("files");
  const req = store.get(id);
  req.onsuccess = ()=>{
    const file = req.result;
    file.name = newName;
    store.put(file);
    tx.oncomplete = loadFiles;
  };
}

function deleteFile(id){
  if(confirm("Delete this item?")){
    const tx = db.transaction("files", "readwrite");
    tx.objectStore("files").delete(id);
    tx.oncomplete = loadFiles;
  }
}

function previewFile(id){
  const tx = db.transaction("files", "readonly");
  const store = tx.objectStore("files");
  const req = store.get(id);
  req.onsuccess = ()=>{
    alert(`Preview of ${req.result.name}:\n\n${req.result.content}`);
  };
}

function searchFiles(){
  const term = document.getElementById('searchBox').value;
  loadFiles(term);
}
</script>

</body>
</html>
