<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Docard - Local Storage</title>
<link rel="stylesheet" href="css/style.css">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;600" rel="stylesheet">
</head>
<body class="light">

<header>
    <button onclick="exitToHome()" title="Dashboard"><span class="material-symbols-outlined">home</span></button>
    <button onclick="goBackManager()" title="Back"><span class="material-symbols-outlined">arrow_back</span></button>
    <div id="storageInfo" class="storage-info">Used: 0 / 100 MB</div>
    <div class="toolbar">
        <button onclick="openSettings()" title="Settings"><span class="material-symbols-outlined">settings</span></button>
        <button onclick="toggleTheme()" id="themeIcon" title="Theme"><span class="material-symbols-outlined">light_mode</span></button>
    </div>
</header>

<div class="main-content">
    <div id="breadcrumb-wrapper"><div id="breadcrumb"></div></div>
    <input type="text" id="searchBar" placeholder="Search files..." oninput="searchFiles(this.value)">
    <div id="fileArea"></div>
</div>

<!-- Floating + Button -->
<div class="fab" id="fabBtn" onclick="toggleFab()"><span class="material-symbols-outlined">add</span></div>
<div id="fabMenu">
    <button onclick="createFolder()">Create Folder</button>
    <button onclick="uploadFile()">Upload File</button>
</div>

<!-- File Operations Toolbar -->
<div id="fileOperations">
    <button onclick="downloadSelected()">Download</button>
    <button onclick="renameSelected()">Rename</button>
    <button onclick="deleteSelected()">Delete</button>
    <button onclick="cancelSelection()">Cancel</button>
</div>

<input type="file" id="fileInput" multiple style="display:none;" onchange="handleFileUpload(event)">

<div id="previewModal" onclick="closePreview(event)">
    <div id="previewContent"></div>
    <button id="previewClose" onclick="closePreview()"><span class="material-symbols-outlined">close</span></button>
</div>

<div id="detailsModal">
    <div id="detailsContent">
        <button onclick="closeDetailsModal()" style="position:absolute; top:12px; right:12px;">✖</button>
        <div id="detailsContentInner"></div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="js/local.js"></script>
<script>
/* --- File Manager Integration --- */
let path = ['/'];
let files = JSON.parse(localStorage.getItem('files')||'{"\/":{}}');
let selectedFiles = [];

// Current folder object
function getCurrentFolder() {
    let folder = files;
    path.forEach(p => folder = folder[p]);
    return folder;
}

// Breadcrumb
function renderBreadcrumb() {
    const bc = document.getElementById('breadcrumb');
    bc.innerHTML = '';
    path.forEach((p,i)=>{
        let span = document.createElement('span');
        span.innerText = (i===0?'Root':p);
        span.onclick = ()=>navigateTo(i);
        bc.appendChild(span);
        if(i<path.length-1) bc.appendChild(document.createTextNode(' / '));
    });
}

// Navigate
function navigateTo(i){ path = path.slice(0,i+1); renderFiles(); }
function goBackManager(){ if(path.length>1){ path.pop(); renderFiles(); } else { exitToHome(); } }

// Render Files
function renderFiles(){
    renderBreadcrumb();
    const fileArea = document.getElementById('fileArea');
    fileArea.innerHTML = '';
    const folderObj = getCurrentFolder();
    selectedFiles = [];
    toggleFileOperations(false);

    for(let name in folderObj){
        if(typeof folderObj[name]==='object' && folderObj[name].content===undefined){ // folder
            const div = document.createElement('div');
            div.className = 'folder';
            div.innerText = '📁 '+name;
            div.onclick = ()=>{ path.push(name); renderFiles(); };
            fileArea.appendChild(div);
        } else { // file
            const div = document.createElement('div');
            div.className = 'file';
            div.innerHTML = `<span>📄 ${name}</span><input type="checkbox" onchange="toggleSelect(this,'${name}')">`;
            fileArea.appendChild(div);
        }
    }
    updateStorageInfo();
}

// Floating button
function toggleFab(){ const menu=document.getElementById('fabMenu'); menu.style.display=menu.style.display==='flex'?'none':'flex'; }

// Folder/File Operations
function createFolder(){
    const name = prompt('Folder Name:');
    if(!name) return;
    const folderObj = getCurrentFolder();
    if(folderObj[name]){ showToast('Folder exists'); return; }
    folderObj[name] = {};
    localStorage.setItem('files',JSON.stringify(files));
    renderFiles();
}
function uploadFile(){ document.getElementById('fileInput').click(); toggleFab(); }
function handleFileUpload(e){
    for(const file of e.target.files){
        const reader = new FileReader();
        reader.onload = function(){ getCurrentFolder()[file.name]={content:reader.result,size:file.size,type:file.type}; localStorage.setItem('files',JSON.stringify(files)); renderFiles(); showToast('Uploaded '+file.name); };
        reader.readAsDataURL(file);
    }
    e.target.value='';
}
function toggleSelect(cb,name){
    if(cb.checked) selectedFiles.push(name);
    else selectedFiles = selectedFiles.filter(n=>n!==name);
    toggleFileOperations(selectedFiles.length>0);
}
function toggleFileOperations(show){ document.getElementById('fileOperations').style.display=show?'flex':'none'; }
function downloadSelected(){
    const folderObj = getCurrentFolder();
    selectedFiles.forEach(name=>{
        const a = document.createElement('a');
        a.href = folderObj[name].content || folderObj[name];
        a.download = name;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });
    cancelSelection();
}
function deleteSelected(){
    if(!confirm('Delete selected?')) return;
    const folderObj = getCurrentFolder();
    selectedFiles.forEach(name=>delete folderObj[name]);
    localStorage.setItem('files',JSON.stringify(files));
    cancelSelection();
    renderFiles();
}
function renameSelected(){
    if(selectedFiles.length!==1){ showToast('Select 1 item'); return; }
    const oldName = selectedFiles[0];
    const newName = prompt('New Name:',oldName);
    if(!newName) return;
    const folderObj = getCurrentFolder();
    folderObj[newName] = folderObj[oldName];
    delete folderObj[oldName];
    localStorage.setItem('files',JSON.stringify(files));
    cancelSelection();
    renderFiles();
}
function cancelSelection(){ selectedFiles=[]; document.querySelectorAll('#fileArea input[type=checkbox]').forEach(cb=>cb.checked=false); toggleFileOperations(false); }

// Theme
function toggleTheme(){
    document.body.classList.toggle('dark');
    document.getElementById('themeIcon').innerText=document.body.classList.contains('dark')?'dark_mode':'light_mode';
    localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light');
}
if(localStorage.getItem('theme')==='dark'){document.body.classList.add('dark'); document.getElementById('themeIcon').innerText='dark_mode';}

// Storage info
function updateStorageInfo(){
    let total=0;
    function flatten(obj){ let arr=[]; for(let k in obj){ if(typeof obj[k]==='object'){ if(obj[k].content) arr.push(obj[k]); else arr=arr.concat(flatten(obj[k])); } } return arr; }
    flatten(files['/']).forEach(f=>total+=f.size||0);
    document.getElementById('storageInfo').innerText=`Used: ${(total/1024/1024).toFixed(2)} / 100 MB`;
}

// Toast
function showToast(msg){ const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); }

// Initial
renderFiles();
</script>

</body>
</html>
