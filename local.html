<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docard - Local File Manager</title>
  <!-- Google Fonts & Material Icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@700" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left" style="display: flex; align-items: center; gap: 0.8rem;">
      <button class="icon-btn" id="homeBtn" title="Home">
        <span class="material-symbols-outlined">home</span>
      </button>
      <button class="icon-btn" id="backBtn" title="Back">
        <span class="material-symbols-outlined">arrow_back</span>
      </button>
      <span class="docard-title" style="font-weight:700; font-size:1.27rem; letter-spacing:1px;">Local</span>
      <div class="breadcrumb-block" id="breadcrumb"></div>
    </div>
    <div class="header-right" style="display: flex; align-items: center; gap: 0.3em;">
      <button class="search-btn icon-btn" id="searchBtn" title="Search">
        <span class="material-symbols-outlined">search</span>
      </button>
      <button id="settingsBtn" class="icon-btn material-symbols-outlined" aria-label="Settings" title="Menu">more_vert</button>
      <div id="settingsMenu" class="settings-dropdown">
        <button onclick="location.href='local.html'">üìÇ Local Storage</button>
        <button onclick="location.href='cloud.html'">‚òÅÔ∏è Cloud Storage</button>
        <button onclick="toggleTheme()">üåô Toggle Theme</button>
        <button onclick="sortFiles()">Sort Files</button>
        <button onclick="showDetailsSelected()">File Details</button>
        <button onclick="downloadSelected()">Download</button>
        <button onclick="renameSelected()">Rename</button>
        <button onclick="confirmDeleteSelected()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Storage Bar -->
  <div class="storage-bar">
    <div class="used" id="storageUsed"></div>
    <span class="storage-label" id="storageLabel"></span>
  </div>

  <!-- Main Manager Container -->
  <div class="manager-container">
    <div class="folder-list-container">
      <div id="fileArea" tabindex="0" aria-label="File List"></div>
    </div>
  </div>

  <input type="file" id="fileInput" style="display:none;" multiple onchange="handleFileUpload(event)">
  <div class="toast" id="toast"></div>

  <!-- Scripts -->
  <script>
    // ===== Settings Menu =====
    const settingsBtn=document.getElementById('settingsBtn');
    const settingsMenu=document.getElementById('settingsMenu');
    document.body.addEventListener('click',e=>{
      if(!settingsMenu.contains(e.target)&&e.target!==settingsBtn){settingsMenu.classList.remove('show');}
    });
    settingsBtn.addEventListener('click',(e)=>{
      e.stopPropagation();settingsMenu.classList.toggle('show');
    });

    // ===== Toolbar Buttons =====
    document.getElementById('homeBtn').onclick = () => {
      path = ['/'];
      renderFiles();
    };
    document.getElementById('backBtn').onclick = () => {
      if (path.length > 1) {
        path.pop();
        renderFiles();
      }
    };

    // ===== Storage Usage =====
    function updateStorageUsage(usedPercent, usedString){
      document.getElementById('storageUsed').style.width=usedPercent+"%";
      document.getElementById('storageLabel').innerText = usedString;
    }

    // ===== Theme Toggle =====
    function toggleTheme(){
      document.body.classList.toggle("light");
      showToast("Theme toggled");
    }

    // ===== File Manager State =====
    let files = JSON.parse(localStorage.getItem('files') || '{"\\/":{}}');
    let path = ['/'];
    let selectedItems = [];
    let searchQuery = '';
    let sortOrder = 'name';

    // ===== Helper Functions =====
    function getCurrentFolder() {
      let f = files;
      for (let i = 1; i < path.length; i++) f = f[path[i]];
      return f;
    }
    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
    function formatDate(ts) {
      if (!ts) return '';
      let d = new Date(ts);
      let day = d.getDate();
      let month = d.toLocaleString('default', { month: 'short' });
      return day + ' ' + month;
    }

    // ===== Breadcrumb Rendering =====
    function renderBreadcrumb() {
      const bc = document.getElementById('breadcrumb');
      bc.innerHTML = '';
      path.forEach((p, i) => {
        let span = document.createElement('span');
        span.innerText = (i === 0 ? "All files" : p);
        if (i < path.length - 1) {
          span.onclick = () => navigateTo(i);
          span.tabIndex = 0;
        } else {
          span.style.color = "#ffd600";
        }
        bc.appendChild(span);
        if (i < path.length - 1) {
          let slash = document.createElement('span');
          slash.innerText = ' / ';
          slash.className = 'slash';
          bc.appendChild(slash);
        }
      });
    }
    function navigateTo(i) {
      path = path.slice(0, i + 1);
      renderFiles();
    }

    // ===== File List Rendering =====
    function renderFiles() {
      renderBreadcrumb();
      const fileArea = document.getElementById('fileArea');
      fileArea.innerHTML = '';
      selectedItems = [];
      let folderObj = getCurrentFolder();
      let items = Object.keys(folderObj).map(name => {
        let isFolder = typeof folderObj[name] === 'object' && !folderObj[name].content;
        return { name, isFolder, obj: folderObj[name] };
      });
      items = items.filter(item => {
        if (searchQuery && !item.name.toLowerCase().includes(searchQuery.toLowerCase())) return false;
        return true;
      });
      if (sortOrder === 'name') items.sort((a, b) => a.name.localeCompare(b.name));
      else if (sortOrder === 'size') items.sort((a, b) => (b.obj.size || 0) - (a.obj.size || 0));
      // Show item count
      let countDiv = document.createElement('div');
      countDiv.style.color = "#ccc";
      countDiv.style.fontSize = "1.04em";
      countDiv.style.margin = "0.1em 0 0.7em 0.1em";
      countDiv.innerText = items.length + " item" + (items.length !== 1 ? "s" : "") + " in total";
      fileArea.appendChild(countDiv);
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.tabIndex = 0;
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(item.name, item.isFolder)}</span>
          <div class="file-info">
            <span class="file-name">${item.name}</span>
            <span class="file-meta">${item.isFolder ?
              (Object.keys(item.obj).length + " items") : formatBytes(item.obj.size || 0)}
              ${item.isFolder ? " | " + (item.obj.lastModified ? formatDate(item.obj.lastModified) : "") : (item.obj.lastModified ? " | " + formatDate(item.obj.lastModified) : "")}
            </span>
          </div>
          <span class="arrow material-symbols-outlined">${item.isFolder ? "chevron_right" : ""}</span>
        `;
        div.onclick = function(e) {
          document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
          div.classList.add('selected');
          selectedItems = [{ name: item.name, isFolder: item.isFolder }];
          if (item.isFolder && (e.target.classList.contains('arrow') || e.target.classList.contains('file-icon') || e.target.classList.contains('file-name'))) {
            path.push(item.name);
            renderFiles();
          }
          else if (!item.isFolder && (e.target.classList.contains('file-info') || e.target.classList.contains('file-name') || e.target.classList.contains('file-icon'))) {
            previewFile(item.name);
          }
        };
        div.ondblclick = () => { showDetails(item.name, item.isFolder); };
        fileArea.appendChild(div);
      });
      updateStorageBar();
    }

    // ===== File Icon =====
    function getFileIcon(name, isFolder) {
      if (isFolder) return '<span class="material-symbols-outlined">folder</span>';
      let ext = name.split('.').pop().toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) return '<span class="material-symbols-outlined">image</span>';
      if (['pdf', 'doc', 'docx', 'txt', 'xlsx', 'xls', 'pptx', 'csv', 'md'].includes(ext)) return '<span class="material-symbols-outlined">description</span>';
      if (['mp4', 'mov', 'avi', 'webm', 'mkv'].includes(ext)) return '<span class="material-symbols-outlined">movie</span>';
      return '<span class="material-symbols-outlined">insert_drive_file</span>';
    }

    // ===== File Actions =====
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.style.display = 'block';
      setTimeout(() => { t.style.display = 'none'; }, 1200);
    }
    function sortFiles() {
      sortOrder = sortOrder === 'name' ? 'size' : 'name';
      renderFiles();
      showToast('Sorted by ' + (sortOrder === 'name' ? 'Name' : 'Size'));
    }
    function showDetailsSelected() {
      if (selectedItems.length !== 1) return showToast('Select only one item');
      showDetails(selectedItems[0].name, selectedItems[0].isFolder);
    }
    function showDetails(name, isFolder) {
      const f = getCurrentFolder()[name];
      if (!f) return showToast('File not found!');
      let details =
        `Type: ${isFolder ? 'Folder' : (f.type || 'Unknown')}\n` +
        `Size: ${isFolder ? 'N/A' : formatBytes(f.size || 0)}\n` +
        `Last Modified: ${isFolder ? 'N/A' : (f.lastModified ? new Date(f.lastModified).toLocaleString() : '')}`;
      alert(details);
    }
    function renameSelected() {
      if (selectedItems.length !== 1) return showToast('Select only one item');
      const oldName = selectedItems[0].name;
      const newName = prompt('New name:', oldName);
      if (!newName || newName.includes('/')) return showToast('Invalid name');
      const f = getCurrentFolder();
      if (f[newName]) return showToast('Name already exists');
      f[newName] = f[oldName];
      delete f[oldName];
      localStorage.setItem('files', JSON.stringify(files));
      renderFiles();
      showToast('Renamed');
    }
    function confirmDeleteSelected() {
      if (selectedItems.length === 0) return showToast('No items selected');
      if (confirm('Are you sure you want to delete selected items?')) {
        deleteSelected();
      }
    }
    function deleteSelected() {
      const f = getCurrentFolder();
      selectedItems.forEach(i => delete f[i.name]);
      selectedItems = [];
      localStorage.setItem('files', JSON.stringify(files));
      renderFiles();
      showToast('Deleted');
    }
    function downloadSelected() {
      selectedItems.forEach(i => {
        const f = getCurrentFolder()[i.name];
        if (!i.isFolder) {
          const a = document.createElement('a');
          a.href = f.content;
          a.download = i.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      });
      selectedItems = [];
      showToast('Downloaded');
    }
    function previewFile(name) {
      const f = getCurrentFolder()[name];
      if (!f) return showToast('File not found!');
      let ext = name.split('.').pop().toLowerCase();
      let isTextFile = ['txt', 'md', 'js', 'json', 'css', 'html', 'csv'].includes(ext);
      let isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext);
      if (isImage || ['pdf'].includes(ext)) {
        window.open(f.content, '_blank');
      } else if (isTextFile) {
        let reader = new FileReader();
        reader.onload = function (ev) { showModal(ev.target.result, name); }
        reader.readAsText(dataURLtoBlob(f.content));
      } else {
        showToast('Preview not available for this file type.');
      }
    }
    function showModal(content, filename) {
      let modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0'; modal.style.left = '0';
      modal.style.width = '100vw'; modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.7)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '200';
      modal.innerHTML = `
        <div style="background:#fff;color:#222;max-width:550px;width:90vw;max-height:70vh;overflow:auto;padding:1.3em 1em;border-radius:12px;box-shadow:0 8px 24px #2226;">
          <div style="font-weight:bold;margin-bottom:0.7em;">${filename}</div>
          <pre style="white-space:pre-wrap;word-break:break-all;font-size:1em;">${content}</pre>
          <button style="margin-top:1em;float:right;background:#1976d2;color:#fff;border:none;border-radius:6px;padding:0.5em 1.3em;cursor:pointer;" onclick="this.parentNode.parentNode.remove()">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ===== Utils =====
    function dataURLtoBlob(dataurl) {
      let arr = dataurl.split(',');
      let mime = arr[0].match(/:(.*?);/)[1];
      let bstr = atob(arr[1]);
      let n = bstr.length;
      let u8arr = new Uint8Array(n);
      while (n--) { u8arr[n] = bstr.charCodeAt(n); }
      return new Blob([u8arr], { type: mime });
    }

    // ===== Search =====
    function searchFiles(q) {
      searchQuery = q;
      renderFiles();
    }

    // ===== Drag & Drop =====
    document.addEventListener('dragover', e => e.preventDefault(), false);
    document.addEventListener('drop', e => {
      if (document.getElementById('fileArea')) {
        e.preventDefault();
        if (e.dataTransfer.files && e.dataTransfer.files.length) {
          document.getElementById('fileInput').files = e.dataTransfer.files;
          handleFileUpload({ target: { files: e.dataTransfer.files } });
        }
      }
    }, false);

    // ===== Storage Bar Calculation =====
    function updateStorageBar() {
      let total = 0;
      function calc(obj) {
        for (let k in obj) {
          if (obj[k].content) total += obj[k].size || 0;
          else calc(obj[k]);
        }
      }
      calc(files['/']);
      let quota = 5 * 1024 * 1024;
      let usedPercent = Math.min(100, (total / quota) * 100);
      let usedString = formatBytes(total) + " / 5 MB";
      updateStorageUsage(usedPercent, usedString);
    }

    // ===== File Upload =====
    function handleFileUpload(e) {
      const f = getCurrentFolder();
      for (const file of e.target.files) {
        const reader = new FileReader();
        reader.onload = function (ev) {
          f[file.name] = {
            content: ev.target.result,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified
          };
          localStorage.setItem('files', JSON.stringify(files));
          renderFiles();
          showToast('File uploaded: ' + file.name);
        };
        reader.readAsDataURL(file);
      }
      e.target.value = '';
    }

    // ===== Init =====
    renderFiles();
    updateStorageBar();

  </script>
</body>
</html>
