<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docard - Local File Manager</title>
  <!-- Google Fonts & Material Icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@700" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
    }
    .header-bar {
      display: flex;
      align-items: center;
      padding: 1rem 1.3rem 0.7rem 1.3rem;
      background: #121212;
      /* Remove box-shadow for flat look */
      box-shadow: none;
      gap: 1.2rem;
      position: relative;
    }
    .header-bar .icon-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.85rem;
      cursor: pointer;
      padding: 0.2em 0.4em;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .header-bar .icon-btn:hover {
      background: #222;
    }
    .header-bar .docard-title {
      font-weight: 700;
      font-size: 1.35rem;
      letter-spacing: 1px;
      margin-right: auto;
      margin-left: 0.6rem;
    }
    .header-bar .search-btn,
    .header-bar .menu-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      margin-left: 0.7rem;
      border-radius: 6px;
    }
    .header-bar .search-btn:hover,
    .header-bar .menu-btn:hover {
      background: #222;
    }
    .header-bar .breadcrumb-block {
      display: flex;
      align-items: center;
      gap: 0.1em;
      font-size: 1.08rem;
      color: #ccc;
      margin-left: 1rem;
      min-width: 0;
      overflow-x: auto;
    }
    .header-bar .breadcrumb-block span {
      cursor: pointer;
      padding: 0 4px;
      border-radius: 4px;
      transition: background .18s;
      white-space: nowrap;
      color: #4597ff;
    }
    .header-bar .breadcrumb-block .slash {
      cursor: default;
      color: #888;
    }
    .header-bar .breadcrumb-block span:not(.slash):hover {
      background: #388e3c22;
      color: #fff;
    }
    /* 3 dots and menu */
    .menu-dropdown {
      position: absolute;
      top: 3.2rem;
      right: 1.3rem;
      background: #222;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.22);
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 30;
    }
    .menu-dropdown.show {
      display: flex;
    }
    .menu-dropdown button {
      background: none;
      border: none;
      color: #fff;
      padding: 0.8em 1.3em;
      text-align: left;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .menu-dropdown button:hover {
      background: #333;
    }
    /* File area container */
    .manager-container {
      background: #181818;
      border-radius: 12px 12px 0 0;
      margin: 0 auto;
      max-width: 900px;
      min-height: 60vh;
      box-shadow: 0 8px 24px rgba(0,0,0,0.10);
      padding-bottom: 2.5em;
      width: 98vw;
    }
    .folder-list-container {
      padding: 1em 0.7em;
      min-height: 300px;
      background: #181818;
      border-radius: 0 0 12px 12px;
      width: 100%;
      box-sizing: border-box;
    }
    #fileArea {
      display: grid;
      grid-gap: 0.5em;
      outline: none;
      margin-top: 0.5em;
      width: 100%;
      box-sizing: border-box;
      grid-template-columns: repeat(auto-fill,minmax(180px,1fr));
    }
    .file-item {
      background: none;
      border-radius: 8px;
      padding: 0.6em 0.5em;
      display: flex;
      align-items: center;
      gap: 0.6em;
      cursor: pointer;
      transition: background 0.18s;
      min-width: 0;
      width: 100%;
      border-bottom: 1px solid #222;
    }
    .file-item:hover, .file-item:focus {
      background: #1976d222;
    }
    .file-icon {
      font-size: 2em;
      color: #4597ff;
      min-width: 2em;
    }
    .file-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.1em;
      min-width: 0;
      overflow: hidden;
    }
    .file-name {
      font-weight: 500;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      font-size: 1.1em;
      color: #fff;
    }
    .file-meta {
      font-size: 0.92em;
      color: #aaa;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    .file-item .arrow {
      margin-left: auto;
      font-size: 1.5em;
      color: #888;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .manager-container { max-width: 100vw; }
      .header-bar { font-size: 1.15rem; padding: 1rem 0.7rem;}
    }
    @media (max-width: 600px) {
      .manager-container { max-width: 100vw; border-radius: 0;}
      .header-bar { padding: 1rem 0.7rem; flex-direction: column; gap: 0.6rem;}
      .menu-dropdown { right: 0.7rem;}
      .breadcrumb-block { font-size: 0.97rem;}
      .folder-list-container {padding: 0.7em 0.2em;}
    }
    @media (max-width: 400px) {
      .header-bar {font-size: 1rem;}
    }
    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 1.5em;
      transform: translateX(-50%);
      background: #1976d2;
      color: #fff;
      border-radius: 8px;
      padding: 0.8em 1.5em;
      font-size: 1em;
      display: none;
      z-index: 99;
      box-shadow: 0 4px 18px #1976d233;
      animation: fadeIn 0.25s;
    }
    @keyframes fadeIn {
      0% { opacity: 0;}
      100% { opacity: 1;}
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <button class="icon-btn" id="homeBtn" title="Home">
      <span class="material-symbols-outlined">home</span>
    </button>
    <button class="icon-btn" id="backBtn" title="Back">
      <span class="material-symbols-outlined">arrow_back</span>
    </button>
    <span class="docard-title" id="folderTitle">Docard</span>
    <div class="breadcrumb-block" id="breadcrumb"></div>
    <button class="search-btn" id="searchBtn" title="Search">
      <span class="material-symbols-outlined">search</span>
    </button>
    <button class="menu-btn" id="menuBtn" title="Menu">
      <span class="material-symbols-outlined">more_vert</span>
    </button>
    <div id="menuDropdown" class="menu-dropdown">
      <button onclick="location.href='local.html'">üìÇ Local Storage</button>
      <button onclick="location.href='cloud.html'">‚òÅÔ∏è Cloud Storage</button>
      <button onclick="toggleTheme()">üåô Toggle Theme</button>
      <button onclick="sortFiles()">Sort Files</button>
      <button onclick="showDetailsSelected()">File Details</button>
      <button onclick="downloadSelected()">Download</button>
      <button onclick="renameSelected()">Rename</button>
      <button onclick="confirmDeleteSelected()">Delete</button>
    </div>
  </div>

  <div class="manager-container">
    <div class="folder-list-container">
      <div id="fileArea" tabindex="0" aria-label="File List"></div>
    </div>
  </div>

  <input type="file" id="fileInput" style="display:none;" multiple onchange="handleFileUpload(event)">
  <div class="toast" id="toast"></div>

  <!-- Search modal -->
  <div id="searchModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:100; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#222; border-radius:10px; max-width:350px; width:90vw; padding:1.2em 1em;">
      <input type="text" id="searchBar" placeholder="Search..." style="width:90%; font-size:1.1em; padding:0.4em 1em; border-radius:6px; border:none; background:#e0e0e0; color:#222;" autofocus oninput="searchFiles(this.value)">
      <button style="margin-left:1em; background:#1976d2; color:#fff; border:none; border-radius:6px; padding:0.5em 1.3em; cursor:pointer;" onclick="closeSearchModal()">Close</button>
    </div>
  </div>

  <script>
    // ===== Menu Dropdown =====
    const menuBtn = document.getElementById('menuBtn');
    const menuDropdown = document.getElementById('menuDropdown');
    document.body.addEventListener('click', e => {
      if (!menuDropdown.contains(e.target) && e.target !== menuBtn) menuDropdown.classList.remove('show');
    });
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle('show');
    });

    // ===== Search Modal =====
    const searchBtn = document.getElementById('searchBtn');
    const searchModal = document.getElementById('searchModal');
    searchBtn.addEventListener('click', () => {
      searchModal.style.display = 'flex';
      setTimeout(() => document.getElementById('searchBar').focus(), 150);
    });
    function closeSearchModal() {
      searchModal.style.display = 'none';
      searchFiles('');
    }

    // ===== File Manager State =====
    let files = JSON.parse(localStorage.getItem('files') || '{"\/":{}}');
    let path = ['/'];
    let selectedItems = [];
    let searchQuery = '';
    let sortOrder = 'name';

    // ===== Helper Functions =====
    function getCurrentFolder() {
      let f = files;
      for (let i = 1; i < path.length; i++) f = f[path[i]];
      return f;
    }
    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
    function formatDate(ts) {
      if (!ts) return '';
      let d = new Date(ts);
      let day = d.getDate();
      let month = d.toLocaleString('default', { month: 'long' });
      return day + ' ' + month;
    }

    // ===== Breadcrumb Rendering =====
    function renderBreadcrumb() {
      const bc = document.getElementById('breadcrumb');
      bc.innerHTML = '';
      path.forEach((p, i) => {
        let span = document.createElement('span');
        span.innerText = (i === 0 ? "All files" : p);
        if (i < path.length - 1) {
          span.onclick = () => navigateTo(i);
          span.tabIndex = 0;
        } else {
          span.style.color = "#4597ff";
        }
        bc.appendChild(span);
        if (i < path.length - 1) {
          let slash = document.createElement('span');
          slash.innerText = ' ‚ñ∏ ';
          slash.className = 'slash';
          bc.appendChild(slash);
        }
      });
      // Set folder title to current folder name
      document.getElementById('folderTitle').innerText = path[path.length-1] || "Docard";
    }
    function navigateTo(i) {
      path = path.slice(0, i + 1);
      renderFiles();
    }
    document.getElementById('homeBtn').onclick = () => {
      path = ['/'];
      renderFiles();
    };
    document.getElementById('backBtn').onclick = () => {
      if (path.length > 1) {
        path.pop();
        renderFiles();
      }
    };

    // ===== File List Rendering =====
    function renderFiles() {
      renderBreadcrumb();
      const fileArea = document.getElementById('fileArea');
      fileArea.innerHTML = '';
      selectedItems = [];

      let folderObj = getCurrentFolder();
      let items = Object.keys(folderObj).map(name => {
        let isFolder = typeof folderObj[name] === 'object' && !folderObj[name].content;
        return { name, isFolder, obj: folderObj[name] };
      });

      items = items.filter(item => {
        if (searchQuery && !item.name.toLowerCase().includes(searchQuery.toLowerCase())) return false;
        return true;
      });

      if (sortOrder === 'name') items.sort((a, b) => a.name.localeCompare(b.name));
      else if (sortOrder === 'size') items.sort((a, b) => (b.obj.size || 0) - (a.obj.size || 0));

      // Show item count
      let countDiv = document.createElement('div');
      countDiv.style.color = "#ccc";
      countDiv.style.fontSize = "1.02em";
      countDiv.style.margin = "0.3em 0 0.7em 0.1em";
      countDiv.innerText = items.length + " item" + (items.length !== 1 ? "s" : "") + " in total";
      fileArea.appendChild(countDiv);

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.tabIndex = 0;
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(item.name, item.isFolder)}</span>
          <div class="file-info">
            <span class="file-name">${item.name}</span>
            <span class="file-meta">${item.isFolder ? 
              (Object.keys(item.obj).length + " items") : formatBytes(item.obj.size || 0)}
              ${item.isFolder ? " | " + (item.obj.lastModified ? formatDate(item.obj.lastModified) : "") : (item.obj.lastModified ? " | " + formatDate(item.obj.lastModified) : "")}
            </span>
          </div>
          <span class="arrow material-symbols-outlined">chevron_right</span>
        `;
        if (item.isFolder) {
          div.onclick = (e) => {
            path.push(item.name);
            renderFiles();
          };
        } else {
          div.onclick = () => { previewFile(item.name); };
        }
        div.ondblclick = () => { showDetails(item.name, item.isFolder); };
        fileArea.appendChild(div);
      });
    }

    // ===== File Icon =====
    function getFileIcon(name, isFolder) {
      if (isFolder) return '<span class="material-symbols-outlined">folder</span>';
      let ext = name.split('.').pop().toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) return '<span class="material-symbols-outlined">image</span>';
      if (['pdf', 'doc', 'docx', 'txt', 'xlsx', 'xls', 'pptx', 'csv', 'md'].includes(ext)) return '<span class="material-symbols-outlined">description</span>';
      if (['mp4', 'mov', 'avi', 'webm', 'mkv'].includes(ext)) return '<span class="material-symbols-outlined">movie</span>';
      return '<span class="material-symbols-outlined">insert_drive_file</span>';
    }

    // ===== File Actions =====
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.style.display = 'block';
      setTimeout(() => { t.style.display = 'none'; }, 1200);
    }
    function toggleTheme() {
      document.body.classList.toggle("light");
      showToast("Theme toggled");
    }
    function sortFiles() {
      sortOrder = sortOrder === 'name' ? 'size' : 'name';
      renderFiles();
      showToast('Sorted by ' + (sortOrder === 'name' ? 'Name' : 'Size'));
    }
    function showDetailsSelected() {
      if (selectedItems.length !== 1) return showToast('Select only one item');
      showDetails(selectedItems[0].name, selectedItems[0].isFolder);
    }
    function showDetails(name, isFolder) {
      const f = getCurrentFolder()[name];
      if (!f) return showToast('File not found!');
      let details =
        `Type: ${isFolder ? 'Folder' : (f.type || 'Unknown')}\n` +
        `Size: ${isFolder ? 'N/A' : formatBytes(f.size || 0)}\n` +
        `Last Modified: ${isFolder ? 'N/A' : (f.lastModified ? new Date(f.lastModified).toLocaleString() : '')}`;
      alert(details);
    }
    function renameSelected() {
      if (selectedItems.length !== 1) return showToast('Select only one item');
      const oldName = selectedItems[0].name;
      const newName = prompt('New name:', oldName);
      if (!newName || newName.includes('/')) return showToast('Invalid name');
      const f = getCurrentFolder();
      if (f[newName]) return showToast('Name already exists');
      f[newName] = f[oldName];
      delete f[oldName];
      localStorage.setItem('files', JSON.stringify(files));
      renderFiles();
      showToast('Renamed');
    }
    function confirmDeleteSelected() {
      if (selectedItems.length === 0) return showToast('No items selected');
      if (confirm('Are you sure you want to delete selected items?')) {
        deleteSelected();
      }
    }
    function deleteSelected() {
      const f = getCurrentFolder();
      selectedItems.forEach(i => delete f[i.name]);
      selectedItems = [];
      localStorage.setItem('files', JSON.stringify(files));
      renderFiles();
      showToast('Deleted');
    }
    function downloadSelected() {
      selectedItems.forEach(i => {
        const f = getCurrentFolder()[i.name];
        if (!i.isFolder) {
          const a = document.createElement('a');
          a.href = f.content;
          a.download = i.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      });
      selectedItems = [];
      showToast('Downloaded');
    }
    function previewFile(name) {
      const f = getCurrentFolder()[name];
      if (!f) return showToast('File not found!');
      let ext = name.split('.').pop().toLowerCase();
      let isTextFile = ['txt', 'md', 'js', 'json', 'css', 'html', 'csv'].includes(ext);
      let isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext);
      if (isImage || ['pdf'].includes(ext)) {
        window.open(f.content, '_blank');
      } else if (isTextFile) {
        let reader = new FileReader();
        reader.onload = function (ev) { showModal(ev.target.result, name); }
        reader.readAsText(dataURLtoBlob(f.content));
      } else {
        showToast('Preview not available for this file type.');
      }
    }
    function showModal(content, filename) {
      let modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0'; modal.style.left = '0';
      modal.style.width = '100vw'; modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.7)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '200';
      modal.innerHTML = `
        <div style="background:#fff;color:#222;max-width:550px;width:90vw;max-height:70vh;overflow:auto;padding:1.3em 1em;border-radius:12px;box-shadow:0 8px 24px #2226;">
          <div style="font-weight:bold;margin-bottom:0.7em;">${filename}</div>
          <pre style="white-space:pre-wrap;word-break:break-all;font-size:1em;">${content}</pre>
          <button style="margin-top:1em;float:right;background:#1976d2;color:#fff;border:none;border-radius:6px;padding:0.5em 1.3em;cursor:pointer;" onclick="this.parentNode.parentNode.remove()">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }
    // ===== Selection logic (for menu actions) =====
    // For demo, select last clicked file/folder
    document.getElementById('fileArea').onclick = function(e) {
      let itemDiv = e.target.closest('.file-item');
      if (!itemDiv) return;
      let name = itemDiv.querySelector('.file-name').innerText;
      let isFolder = itemDiv.querySelector('.file-icon .material-symbols-outlined').innerText === 'folder';
      selectedItems = [{ name, isFolder }];
    };

    // ===== Search, Sort =====
    function searchFiles(q) {
      searchQuery = q;
      renderFiles();
    }

    // ===== Utils =====
    function dataURLtoBlob(dataurl) {
      let arr = dataurl.split(',');
      let mime = arr[0].match(/:(.*?);/)[1];
      let bstr = atob(arr[1]);
      let n = bstr.length;
      let u8arr = new Uint8Array(n);
      while (n--) { u8arr[n] = bstr.charCodeAt(n); }
      return new Blob([u8arr], { type: mime });
    }

    // ===== File Upload =====
    function handleFileUpload(e) {
      const f = getCurrentFolder();
      for (const file of e.target.files) {
        const reader = new FileReader();
        reader.onload = function (ev) {
          f[file.name] = {
            content: ev.target.result,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified
          };
          localStorage.setItem('files', JSON.stringify(files));
          renderFiles();
          showToast('File uploaded: ' + file.name);
        };
        reader.readAsDataURL(file);
      }
      e.target.value = '';
    }

    // ===== Init =====
    renderFiles();
  </script>
</body>
</html>
