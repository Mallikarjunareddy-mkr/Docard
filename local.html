<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docard - Local File Manager</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@700" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header">
      Docard
      <a href="index.html" class="back-btn" title="Back to Home">
          <span class="material-symbols-outlined">arrow_back</span>Home
      </a>
      <button id="settingsBtn" class="material-symbols-outlined">settings</button>
      <div id="settingsMenu" class="settings-dropdown">
          <button onclick="location.href='local.html'">üìÇ Local Storage</button>
          <button onclick="location.href='cloud.html'">‚òÅÔ∏è Cloud Storage</button>
          <button onclick="toggleTheme()">üåô Toggle Theme</button>
      </div>
  </div>

  <!-- Storage Tracker -->
  <div class="storage-bar">
    <div class="used" id="storageUsed"></div>
  </div>

  <div class="manager-container">
      <div class="manager-toolbar">
          <button id="backBtn" onclick="goBackManager()" title="Go Back" class="icon-btn">
              <span class="material-symbols-outlined">arrow_back</span>
          </button>
          <div class="breadcrumb-block" id="breadcrumb"></div>
          <div class="toolbar-actions">
              <input type="text" id="searchBar" placeholder="Search..." oninput="searchFiles(this.value)">
              <button onclick="sortFiles()" title="Sort">
                  <span class="material-symbols-outlined">sort</span>
              </button>
              <button onclick="toggleView()" title="Change View">
                  <span class="material-symbols-outlined" id="viewIcon">view_list</span>
              </button>
          </div>
      </div>
      <div class="folder-list-container">
          <div id="fileArea" tabindex="0"></div>
      </div>
  </div>

  <!-- FAB and Menus -->
  <div class="fab" id="fabBtn" onclick="fabAction()"><span class="material-symbols-outlined">add</span></div>
  <div id="fabMenu">
      <button onclick="createFolder()"><span class="material-symbols-outlined">create_new_folder</span> New Folder</button>
      <button onclick="uploadFile()"><span class="material-symbols-outlined">upload_file</span> Upload</button>
  </div>
  <div id="fileOperations">
      <button onclick="previewSelected()"><span class="material-symbols-outlined">preview</span> Preview</button>
      <button onclick="showDetailsSelected()"><span class="material-symbols-outlined">info</span> Details</button>
      <button onclick="downloadSelected()"><span class="material-symbols-outlined">download</span> Download</button>
      <button onclick="renameSelected()"><span class="material-symbols-outlined">edit</span> Rename</button>
      <button onclick="confirmDeleteSelected()"><span class="material-symbols-outlined">delete</span> Delete</button>
      <button onclick="cancelSelection()"><span class="material-symbols-outlined">cancel</span> Cancel</button>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" style="display:none;" multiple onchange="handleFileUpload(event)">
  <div class="toast" id="toast"></div>

  <script src="script.js"></script>
  <script>
    /* Settings menu toggle */
    const settingsBtn=document.getElementById('settingsBtn');
    const settingsMenu=document.getElementById('settingsMenu');
    settingsBtn.addEventListener('click',()=>{settingsMenu.classList.toggle('show');});

    /* Fake storage usage */
    function updateStorageUsage(usedPercent){
      document.getElementById('storageUsed').style.width=usedPercent+"%";
    }
    updateStorageUsage(40); // example

    function toggleTheme(){
      document.body.classList.toggle("light");
      showToast("Theme toggled");
    }

    // ===== File Manager Data =====
let files = JSON.parse(localStorage.getItem('files') || '{"\/":{}}');
let path = ['/'];
let selectedItems = [];
let isGrid = false;
let searchQuery = '';
let sortOrder = 'name';

// ===== Helpers =====
function getCurrentFolder() {
  let f = files;
  for (let i = 1; i < path.length; i++) f = f[path[i]];
  return f;
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  else return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// ===== Breadcrumb =====
function renderBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  bc.innerHTML = '';
  path.forEach((p, i) => {
    let span = document.createElement('span');
    span.innerText = (i === 0 ? "Root" : p);
    span.onclick = () => navigateTo(i);
    bc.appendChild(span);
    if (i < path.length - 1) {
      let slash = document.createElement('span');
      slash.innerText = ' / ';
      slash.className = 'slash';
      bc.appendChild(slash);
    }
  });
}

function navigateTo(i) {
  path = path.slice(0, i + 1);
  renderFiles();
}

function goBackManager() {
  if (path.length > 1) {
    path.pop();
    renderFiles();
  }
}

// ===== Rendering =====
function renderFiles() {
  renderBreadcrumb();
  const fileArea = document.getElementById('fileArea');
  fileArea.innerHTML = '';
  selectedItems = [];
  updateFabIcon();
  toggleFileOperations(false);

  let folderObj = getCurrentFolder();
  let items = Object.keys(folderObj).map(name => {
    let isFolder = typeof folderObj[name] === 'object' && !folderObj[name].content;
    return { name, isFolder, obj: folderObj[name] };
  });

  items = items.filter(item => {
    if (searchQuery && !item.name.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  if (sortOrder === 'name') items.sort((a, b) => a.name.localeCompare(b.name));
  else if (sortOrder === 'size') items.sort((a, b) => (b.obj.size || 0) - (a.obj.size || 0));

  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.tabIndex = 0;
    div.innerHTML = `
      <span class="file-checkbox">
        <input type="checkbox" onchange="toggleSelect(this,'${item.name}',${item.isFolder})">
      </span>
      <span class="file-icon">${getFileIcon(item.name, item.isFolder)}</span>
      <div class="file-info">
        <span class="file-name">${item.name}</span>
        <span class="file-meta">${item.isFolder ? 'Folder' : (item.obj.size ? formatBytes(item.obj.size) : '')}</span>
      </div>
    `;

    if (item.isFolder) {
      div.onclick = (e) => {
        if (e.target.tagName.toLowerCase() !== 'input') {
          path.push(item.name);
          renderFiles();
        }
      };
    } else {
      div.querySelector('.file-info').onclick = () => { previewFile(item.name); };
      div.querySelector('.file-icon').onclick = () => { previewFile(item.name); };
      div.onkeydown = (e) => { if (e.key === 'Enter') previewFile(item.name); };
    }

    div.querySelector('.file-info').ondblclick = () => { showDetails(item.name, item.isFolder); };
    fileArea.appendChild(div);
  });

  document.getElementById('fileArea').style.gridTemplateColumns = isGrid
    ? 'repeat(auto-fill,minmax(65px,1fr))'
    : 'repeat(auto-fill,minmax(110px,1fr))';

  document.getElementById('viewIcon').innerText = isGrid ? 'grid_view' : 'view_list';

  updateStorageBar();
}

// ===== Icons =====
function getFileIcon(name, isFolder) {
  if (isFolder) return '<span class="material-symbols-outlined">folder</span>';
  let ext = name.split('.').pop().toLowerCase();
  if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) return '<span class="material-symbols-outlined">image</span>';
  if (['pdf', 'doc', 'docx', 'txt', 'xlsx', 'xls', 'pptx', 'csv', 'md'].includes(ext)) return '<span class="material-symbols-outlined">description</span>';
  if (['mp4', 'mov', 'avi', 'webm', 'mkv'].includes(ext)) return '<span class="material-symbols-outlined">movie</span>';
  return '<span class="material-symbols-outlined">insert_drive_file</span>';
}

// ===== File Selection =====
function toggleSelect(cb, name, isFolder) {
  if (cb.checked) selectedItems.push({ name, isFolder });
  else selectedItems = selectedItems.filter(i => i.name !== name || i.isFolder !== isFolder);
  updateFabIcon();
  toggleFileOperations(false);
}

function cancelSelection() {
  selectedItems = [];
  document.querySelectorAll('#fileArea input[type=checkbox]').forEach(cb => cb.checked = false);
  updateFabIcon();
  toggleFileOperations(false);
}

function updateFabIcon() {
  document.getElementById('fabBtn').innerHTML = selectedItems.length > 0
    ? '<span class="material-symbols-outlined">edit</span>'
    : '<span class="material-symbols-outlined">add</span>';
}

function fabAction() {
  if (selectedItems.length > 0) {
    document.getElementById('fileOperations').style.display = 'flex';
    document.getElementById('fabMenu').style.display = 'none';
  } else {
    document.getElementById('fabMenu').style.display =
      document.getElementById('fabMenu').style.display === 'flex' ? 'none' : 'flex';
    document.getElementById('fileOperations').style.display = 'none';
  }
}

function toggleFileOperations(show) {
  document.getElementById('fileOperations').style.display = show ? 'flex' : 'none';
}

// ===== Actions =====
function createFolder() {
  const name = prompt('Folder Name:');
  if (!name || name.includes('/')) return showToast('Invalid folder name');
  const f = getCurrentFolder();
  if (f[name]) return showToast('Already exists');
  f[name] = {};
  localStorage.setItem('files', JSON.stringify(files));
  renderFiles();
  showToast('Folder created');
}

function uploadFile() {
  document.getElementById('fileInput').click();
  document.getElementById('fabMenu').style.display = 'none';
}

function handleFileUpload(e) {
  const f = getCurrentFolder();
  for (const file of e.target.files) {
    const reader = new FileReader();
    reader.onload = function (ev) {
      f[file.name] = {
        content: ev.target.result,
        size: file.size,
        type: file.type,
        lastModified: file.lastModified
      };
      localStorage.setItem('files', JSON.stringify(files));
      renderFiles();
      showToast('File uploaded: ' + file.name);
    };
    reader.readAsDataURL(file);
  }
  e.target.value = '';
}

function confirmDeleteSelected() {
  if (selectedItems.length === 0) return showToast('No items selected');
  if (confirm('Are you sure you want to delete selected items?')) {
    deleteSelected();
  }
}

function deleteSelected() {
  const f = getCurrentFolder();
  selectedItems.forEach(i => delete f[i.name]);
  selectedItems = [];
  localStorage.setItem('files', JSON.stringify(files));
  renderFiles();
  showToast('Deleted');
}

function renameSelected() {
  if (selectedItems.length !== 1) return showToast('Select only one item');
  const oldName = selectedItems[0].name;
  const newName = prompt('New name:', oldName);
  if (!newName || newName.includes('/')) return showToast('Invalid name');
  const f = getCurrentFolder();
  if (f[newName]) return showToast('Name already exists');
  f[newName] = f[oldName];
  delete f[oldName];
  localStorage.setItem('files', JSON.stringify(files));
  renderFiles();
  showToast('Renamed');
}

function downloadSelected() {
  selectedItems.forEach(i => {
    const f = getCurrentFolder()[i.name];
    if (!i.isFolder) {
      const a = document.createElement('a');
      a.href = f.content;
      a.download = i.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  });
  cancelSelection();
  showToast('Downloaded');
}

function previewSelected() {
  if (selectedItems.length !== 1) return showToast('Select only one item');
  previewFile(selectedItems[0].name);
  selectedItems = [];
  updateFabIcon();
  toggleFileOperations(false);
}

function previewFile(name) {
  const f = getCurrentFolder()[name];
  if (!f) return showToast('File not found!');
  let ext = name.split('.').pop().toLowerCase();
  let isTextFile = ['txt', 'md', 'js', 'json', 'css', 'html', 'csv'].includes(ext);
  let isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext);
  if (isImage || ['pdf'].includes(ext)) {
    window.open(f.content, '_blank');
  } else if (isTextFile) {
    let reader = new FileReader();
    reader.onload = function (ev) { alert(ev.target.result); }
    reader.readAsText(dataURLtoBlob(f.content));
  } else {
    showToast('Preview not available for this file type.');
  }
}

function showDetailsSelected() {
  if (selectedItems.length !== 1) return showToast('Select only one item');
  showDetails(selectedItems[0].name, selectedItems[0].isFolder);
}

function showDetails(name, isFolder) {
  const f = getCurrentFolder()[name];
  if (!f) return showToast('File not found!');
  let details =
    `Type: ${isFolder ? 'Folder' : (f.type || 'Unknown')}\n` +
    `Size: ${isFolder ? 'N/A' : formatBytes(f.size || 0)}\n` +
    `Last Modified: ${isFolder ? 'N/A' : (f.lastModified ? new Date(f.lastModified).toLocaleString() : '')}`;
  alert(details);
}

// ===== Utils =====
function dataURLtoBlob(dataurl) {
  let arr = dataurl.split(',');
  let mime = arr[0].match(/:(.*?);/)[1];
  let bstr = atob(arr[1]);
  let n = bstr.length;
  let u8arr = new Uint8Array(n);
  while (n--) { u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], { type: mime });
}

// ===== Search & Sort & View =====
function searchFiles(q) {
  searchQuery = q;
  renderFiles();
}

function toggleView() {
  isGrid = !isGrid;
  renderFiles();
}

function sortFiles() {
  sortOrder = sortOrder === 'name' ? 'size' : 'name';
  renderFiles();
  showToast('Sorted by ' + (sortOrder === 'name' ? 'Name' : 'Size'));
}

// ===== Drag & Drop =====
document.addEventListener('dragover', e => e.preventDefault(), false);
document.addEventListener('drop', e => {
  if (document.getElementById('fileArea')) {
    e.preventDefault();
    if (e.dataTransfer.files && e.dataTransfer.files.length) {
      document.getElementById('fileInput').files = e.dataTransfer.files;
      handleFileUpload({ target: { files: e.dataTransfer.files } });
    }
  }
}, false);

// ===== Storage Bar =====
function updateStorageBar() {
  let total = 0;
  function calc(obj) {
    for (let k in obj) {
      if (obj[k].content) total += obj[k].size || 0;
      else calc(obj[k]);
    }
  }
  calc(files['/']);
  let usedPercent = Math.min(100, (total / (5 * 1024 * 1024)) * 100); // simulate 5MB quota
  document.getElementById('storageUsed').style.width = usedPercent + "%";
}

// ===== Toast =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.display = 'block';
  setTimeout(() => { t.style.display = 'none'; }, 1200);
}

// ===== Init =====
renderFiles();
    
  </script>
</body>
</html>
